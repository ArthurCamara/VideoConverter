extends layout

block content
  h1= title
  h2 The #{title} will convert any video format to one that is web compatible.
  p.
    The video will be stored on Amazon AWS S3, and converted using the Zencoder plugin.
    This website was built using node.js and Express
  br
  br
  p#status First, upload your file:
  p#percentage
  input#file_input(type='file')
  
  script.
    function get_signed_request_to_AWS(file) {
      //first, we generate the signed URL for the video. The upload comes next, with a PUT request
      var xhr = new XMLHttpRequest()
      xhr.open("GET", "/sign_s3?file_name="+file.name+"&file_type="+file.type);
      xhr.onreadystatechange = function(){
        if(xhr.readyState == 4) {
          if(xhr.status == 200) {
            var response = JSON.parse(xhr.responseText)
            console.log(response)
            upload_video_file(file, response.signed_request, response.url)
          }
          else {
            alert('Something went wrong when signing the file to AWS')
          }
        }
      }
      xhr.send()
    }
    function upload_video_file(file, signed_request, url) {
      console.log("Uploading File... May take a while.")
      document.getElementById("status").text = "Uploading file. Please wait."
      var xhr = new XMLHttpRequest()
      xhr.open("PUT", signed_request)
      xhr.upload.onprogress = function(e){
        var percentage = ((e.loaded/e.total)*100).toFixed(2)
        document.getElementById('percentage').text = percentage
        console.log(e.loaded/e.total)
      }
      console.log(signed_request)
      xhr.setRequestHeader('x-amz-acl', 'public-read')
      xhr.onload = function(){
        //everything is a-ok!
        if(xhr.status == 200){
          document.getElementById("status").text = "File Uploaded!"
          //TODO: Transcode with Zencoder
        }
        else{
          alert("Something went wrong while uploading the file. Try again?\nErr=" + xhr.status)
        }
      }
      xhr.send(file)
    }
    function initiate_upload() {
      var files = document.getElementById('file_input').files;
      var file = files[0]
      console.log(file.type.split('/')[0])
      if (file==null){
        alert("No file was selected")
        return;
      }
      if (file.type.split('/')[0]!="video"){
        alert("file must be a video")
        return;
      }
      //Try to upload the file to AWS, assyncronous.
      get_signed_request_to_AWS(file)
    }
  
  
    (function() {
      var filepicker = document.getElementById('file_input');
      filepicker.onchange = initiate_upload;
      })();